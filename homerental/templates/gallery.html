{% extends "base.html" %}

{% block content %}
<div class="gallery-header">
    <h2>Photo Gallery - {{ portion.name }}</h2>
    <div class="header-actions">
        <a href="{{ url_for('portion_detail', id=portion.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Portion
        </a>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#uploadModal">
            <i class="fas fa-upload"></i> Upload Photos
        </button>
    </div>
</div>

{% if portion.photos %}
<div class="gallery-controls">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search photos...">
        <i class="fas fa-search"></i>
    </div>
    <div class="sort-options">
        <label for="sortSelect">Sort by:</label>
        <select id="sortSelect">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="az">A to Z</option>
            <option value="za">Z to A</option>
        </select>
    </div>
</div>

<div class="gallery-container">
    {% for photo in portion.photos %}
    <div class="gallery-item" data-date="{{ photo.split('_')[1] }}" data-name="{{ photo }}">
        <div class="gallery-item-inner">
            <img src="{{ url_for('serve_gallery', filename=photo) }}" alt="Gallery image {{ loop.index }}">
            <div class="gallery-overlay">
                <div class="gallery-actions">
                    <a href="{{ url_for('serve_gallery', filename=photo) }}" target="_blank" class="btn-action" title="View">
                        <i class="fas fa-expand"></i>
                    </a>
                    <a href="{{ url_for('serve_gallery', filename=photo) }}" download class="btn-action" title="Download">
                        <i class="fas fa-download"></i>
                    </a>
                    <button class="btn-action delete-btn" data-filename="{{ photo }}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="gallery-item-info">
            <p class="photo-name">{{ photo.split('_')[2] | replace('.jpg', '') | replace('.jpeg', '') | replace('.png', '') | replace('_', ' ') | title }}</p>
            <p class="photo-date">{{ photo.split('_')[1][0:4] }}-{{ photo.split('_')[1][4:6] }}-{{ photo.split('_')[1][6:8] }}</p>
        </div>
    </div>
    {% endfor %}
</div>

<div class="gallery-empty" style="display: none;">
    <i class="fas fa-images"></i>
    <h3>No photos found</h3>
    <p>Try adjusting your search or upload new photos</p>
</div>

{% else %}
<div class="empty-state">
    <i class="fas fa-images"></i>
    <h3>No Photos Uploaded Yet</h3>
    <p>Get started by uploading photos of this portion</p>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#uploadModal">
        <i class="fas fa-upload"></i> Upload Photos
    </button>
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Photos</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('upload_photo', id=portion.id) }}" enctype="multipart/form-data" id="uploadForm">
                <div class="modal-body">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop photos here or click to browse</p>
                        <input type="file" name="photo" id="fileInput" multiple accept=".jpg,.jpeg,.png" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" id="browseBtn">Browse Files</button>
                    </div>
                    <div class="file-preview" id="filePreview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>Upload Photos</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this photo? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form method="POST" action="" id="deleteForm">
                    <button type="submit" class="btn btn-danger">Delete Photo</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.gallery-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.gallery-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-box input {
    padding: 8px 15px 8px 35px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 250px;
}

.search-box i {
    position: absolute;
    left: 12px;
    color: #777;
}

.sort-options {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sort-options select {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.gallery-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.gallery-item {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.gallery-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.gallery-item-inner {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
}

.gallery-item:hover img {
    transform: scale(1.05);
}

.gallery-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.gallery-item:hover .gallery-overlay {
    opacity: 1;
}

.gallery-actions {
    display: flex;
    gap: 15px;
}

.btn-action {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #333;
    text-decoration: none;
    transition: all 0.3s;
}

.btn-action:hover {
    background: #3498db;
    color: white;
    transform: scale(1.1);
}

.gallery-item-info {
    padding: 15px;
}

.photo-name {
    font-weight: bold;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.photo-date {
    color: #777;
    font-size: 0.9rem;
}

.empty-state, .gallery-empty {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
}

.empty-state i, .gallery-empty i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #bdc3c7;
}

.empty-state h3, .gallery-empty h3 {
    margin-bottom: 10px;
    color: #2c3e50;
}

.upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
}

.upload-area:hover, .upload-area.dragover {
    border-color: #3498db;
    background-color: #f8f9fa;
}

.upload-area i {
    font-size: 3rem;
    color: #bdc3c7;
    margin-bottom: 15px;
}

.file-preview {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.preview-item {
    position: relative;
    border-radius: 4px;
    overflow: hidden;
}

.preview-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.preview-item .remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    color: #e74c3c;
}

.modal-footer {
    justify-content: space-between;
}

@media (max-width: 768px) {
    .gallery-header, .gallery-controls {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .search-box input {
        width: 100%;
    }
    
    .gallery-container {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    .file-preview {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const galleryItems = document.querySelectorAll('.gallery-item');
    const galleryEmpty = document.querySelector('.gallery-empty');
    const galleryContainer = document.querySelector('.gallery-container');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let visibleItems = 0;
        
        galleryItems.forEach(item => {
            const photoName = item.querySelector('.photo-name').textContent.toLowerCase();
            const photoDate = item.querySelector('.photo-date').textContent.toLowerCase();
            
            if (photoName.includes(searchTerm) || photoDate.includes(searchTerm)) {
                item.style.display = 'block';
                visibleItems++;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (visibleItems === 0 && galleryItems.length > 0) {
            galleryContainer.style.display = 'none';
            galleryEmpty.style.display = 'block';
        } else {
            galleryContainer.style.display = 'grid';
            galleryEmpty.style.display = 'none';
        }
    });
    
    // Sort functionality
    const sortSelect = document.getElementById('sortSelect');
    
    sortSelect.addEventListener('change', function() {
        const sortValue = this.value;
        const container = document.querySelector('.gallery-container');
        const items = Array.from(document.querySelectorAll('.gallery-item'));
        
        items.sort((a, b) => {
            const aDate = a.getAttribute('data-date');
            const bDate = b.getAttribute('data-date');
            const aName = a.getAttribute('data-name').toLowerCase();
            const bName = b.getAttribute('data-name').toLowerCase();
            
            switch(sortValue) {
                case 'newest':
                    return bDate.localeCompare(aDate);
                case 'oldest':
                    return aDate.localeCompare(bDate);
                case 'az':
                    return aName.localeCompare(bName);
                case 'za':
                    return bName.localeCompare(aName);
                default:
                    return 0;
            }
        });
        
        // Remove all items and re-add in sorted order
        items.forEach(item => container.appendChild(item));
    });
    
    // File upload functionality
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const filePreview = document.getElementById('filePreview');
    const uploadBtn = document.getElementById('uploadBtn');
    let files = [];
    
    // Click on area to trigger file input
    uploadArea.addEventListener('click', function(e) {
        if (e.target !== browseBtn) {
            fileInput.click();
        }
    });
    
    // Or use browse button
    browseBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFiles(this.files);
        }
    });
    
    // Handle selected files
    function handleFiles(fileList) {
        files = Array.from(fileList);
        
        // Clear previous preview
        filePreview.innerHTML = '';
        
        // Enable upload button
        uploadBtn.disabled = false;
        
        // Create preview for each file
        files.forEach((file, index) => {
            if (file.type.match('image.*')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    filePreview.appendChild(previewItem);
                    
                    // Add remove functionality
                    previewItem.querySelector('.remove-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-index'));
                        files.splice(idx, 1);
                        previewItem.remove();
                        
                        // Update data-index for remaining items
                        document.querySelectorAll('.preview-item .remove-btn').forEach((btn, i) => {
                            btn.setAttribute('data-index', i);
                        });
                        
                        // Disable upload button if no files
                        if (files.length === 0) {
                            uploadBtn.disabled = true;
                        }
                    });
                };
                
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Form submission with files
    const uploadForm = document.getElementById('uploadForm');
    
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (files.length === 0) return;
        
        // Create form data and append files
        const formData = new FormData();
        files.forEach(file => {
            formData.append('photo', file);
        });
        
        // Send AJAX request
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.success) {
                // Close modal and refresh page
                $('#uploadModal').modal('hide');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading files. Please try again.');
        });
    });
    
    // Delete photo functionality
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const deleteModal = $('#deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            deleteForm.action = `{{ url_for('delete_photo', id=portion.id) }}?filename=${filename}`;
            deleteModal.modal('show');
        });
    });
});
</script>
{% endblock %}